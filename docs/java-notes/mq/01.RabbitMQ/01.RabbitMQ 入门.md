---
title: RabbitMQ å…¥é—¨
date: 2025-09-01
---


## ç›¸å…³æ¦‚å¿µ

![RabbitMQç»“æ„](https://juzicoding.com/img/2025/01KDAEQZ08N3JQDGY0ZE94F0K6.webp)

### AMQPåè®®

AMQP æ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚ç›®æ ‡æ˜¯å®ç°ä¸€ç§åœ¨å…¨è¡Œä¸šå¹¿æ³›ä½¿ç”¨çš„æ ‡å‡†æ¶ˆæ¯ä¸­é—´ä»¶æŠ€æœ¯ï¼Œä»¥ä¾¿é™ä½ä¼ä¸šå’Œç³»ç»Ÿé›†æˆçš„å¼€é”€ï¼Œå¹¶ä¸”å‘å¤§ä¼—æä¾›å·¥ä¸šçº§çš„é›†æˆæœåŠ¡ï¼Œä¸»è¦å®ç°æœ‰ RabbitMQ ã€‚

### ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€æ¶ˆæ¯

- **ç”Ÿäº§è€…**ï¼šæ¶ˆæ¯çš„åˆ›å»ºè€…ï¼Œå‘é€åˆ° RabbitMQ ã€‚
- **æ¶ˆè´¹è€…**ï¼šè¿æ¥åˆ° RabbitMQï¼Œè®¢é˜…åˆ°é˜Ÿåˆ—ä¸Šï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚
- **æ¶ˆæ¯**ï¼šåŒ…å«æœ‰æ•ˆè½½è·å’Œæ ‡ç­¾ï¼Œæœ‰æ•ˆè½½è·æŒ‡è¦ä¼ è¾“çš„æ•°æ®ï¼Œæ ‡ç­¾æè¿°äº†æœ‰æ•ˆè½½è·ï¼Œå¹¶ä¸” RabbitMQ ç”¨å®ƒæ¥å†³å®šè°è·å¾—æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åªèƒ½æ‹¿åˆ°æœ‰æ•ˆè½½è·ï¼Œå¹¶ä¸çŸ¥é“ç”Ÿäº§è€…æ˜¯è°ã€‚

### è¿æ¥

é¦–å…ˆä½œä¸ºå®¢æˆ·ç«¯ï¼Œæ— è®ºæ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œä½ å¦‚æœè¦ä¸ RabbitMQ é€šè®¯çš„è¯ï¼Œä½ ä»¬ä¹‹é—´å¿…é¡»åˆ›å»ºä¸€æ¡ TCP è¿æ¥ï¼Œè¿æ¥åœ¨ RabbitMQ åŸç”Ÿå®¢æˆ·ç«¯ï¼ˆ5.0.0ï¼‰ç‰ˆæœ¬ä¸­é»˜è®¤ä½¿ç”¨ Java çš„åŸç”Ÿ socketï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒ NIOï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ä¿®æ”¹ã€‚

### ä¿¡é“

ä¿¡é“æ˜¯ç”Ÿäº§è€…/æ¶ˆè´¹è€…ä¸ RabbitMQ é€šä¿¡çš„æ¸ é“ã€‚ä¿¡é“æ˜¯å»ºç«‹åœ¨ TCP è¿æ¥ä¸Šçš„è™šæ‹Ÿè¿æ¥ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±æ˜¯è¯´ RabbitMQ åœ¨ä¸€æ¡ TCP ä¸Šå»ºç«‹æˆç™¾ä¸Šåƒä¸ªä¿¡é“æ¥è¾¾åˆ°å¤šä¸ªçº¿ç¨‹å¤„ç†ï¼Œè¿™ä¸ª TCP è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªä¿¡é“ï¼Œä¿¡é“åœ¨ RabbitMQ éƒ½æœ‰å”¯ä¸€çš„ ID ,ä¿è¯äº†ä¿¡é“ç§æœ‰æ€§ï¼Œå¯¹åº”ä¸Šå”¯ä¸€çš„çº¿ç¨‹ä½¿ç”¨ã€‚

::: tip ä¸ºä»€ä¹ˆä¸å»ºç«‹å¤šä¸ª TCP è¿æ¥å‘¢ï¼Ÿ

ä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œç³»ç»Ÿä¸ºæ¯ä¸ªçº¿ç¨‹å¼€è¾Ÿä¸€ä¸ª TCP æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½ï¼Œæ¯ç§’æˆç™¾ä¸Šåƒçš„å»ºç«‹é”€æ¯ TCP ä¼šä¸¥é‡æ¶ˆè€—ç³»ç»Ÿï¼Œæ‰€ä»¥ RabbitMQ é€‰æ‹©å»ºç«‹å¤šä¸ªä¿¡é“ï¼ˆå»ºç«‹åœ¨ TCP çš„è™šæ‹Ÿè¿æ¥ï¼‰è¿æ¥åˆ° RabbitMQ ä¸Šã€‚

:::

### è™šæ‹Ÿä¸»æœº

è™šæ‹Ÿæ¶ˆæ¯æœåŠ¡å™¨ï¼Œvhostï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª mini ç‰ˆçš„ mq æœåŠ¡å™¨ï¼Œæœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šï¼Œæœ€é‡è¦çš„ï¼Œè‡ªå·±çš„æƒé™æœºåˆ¶ï¼ŒVhost æä¾›äº†é€»è¾‘ä¸Šçš„åˆ†ç¦»ï¼Œå¯ä»¥å°†ä¼—å¤šå®¢æˆ·ç«¯è¿›è¡ŒåŒºåˆ†ï¼Œåˆå¯ä»¥é¿å…é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å‘½åå†²çªã€‚Vhost å¿…é¡»åœ¨è¿æ¥æ—¶æŒ‡å®šï¼ŒRabbitMQ åŒ…å«ç¼ºçœ vhostï¼šâ€œ/â€ï¼Œé€šè¿‡ç¼ºçœç”¨æˆ·å’Œå£ä»¤ guest è¿›è¡Œè®¿é—®ã€‚

RabbitMQ é‡Œåˆ›å»ºç”¨æˆ·ï¼Œå¿…é¡»è¦è¢«æŒ‡æ´¾ç»™è‡³å°‘ä¸€ä¸ª vhostï¼Œå¹¶ä¸”åªèƒ½è®¿é—®è¢«æŒ‡æ´¾å†…çš„é˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šï¼ŒVhost å¿…é¡»é€šè¿‡ RabbitMQ çš„ç®¡ç†æ§åˆ¶å·¥å…·åˆ›å»ºã€‚

ç®€å•æ¥è¯´ç±»ä¼¼äº window ç³»ç»Ÿä¸‹çš„åˆ†ç›˜ï¼Œä¸åŒçš„ç›˜å­˜å‚¨ä¸åŒçš„å†…å®¹ã€‚

### äº¤æ¢å™¨ã€é˜Ÿåˆ—ã€ç»‘å®šã€è·¯ç”±é”®

é˜Ÿåˆ—é€šè¿‡è·¯ç”±é”®ï¼ˆrouting keyï¼ŒæŸç§ç¡®å®šçš„è§„åˆ™ï¼‰ç»‘å®šåˆ°äº¤æ¢å™¨ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°äº¤æ¢å™¨ï¼Œäº¤æ¢å™¨æ ¹æ®ç»‘å®šçš„è·¯ç”±é”®å°†æ¶ˆæ¯è·¯ç”±åˆ°ç‰¹å®šé˜Ÿåˆ—ï¼Œç„¶åç”±è®¢é˜…è¿™ä¸ªé˜Ÿåˆ—çš„æ¶ˆè´¹è€…è¿›è¡Œæ¥æ”¶ï¼ˆrouting_key å’Œ ç»‘å®šé”® binding_key çš„æœ€å¤§é•¿åº¦æ˜¯ 255 ä¸ªå­—èŠ‚ï¼‰ã€‚

### äº¤æ¢å™¨ç±»å‹

å…±æœ‰å››ç§ Directï¼ŒFanoutï¼ŒTopicï¼ŒHeadersï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å‰3ç§ã€‚

`Direct Exchange`

ç›´è¿äº¤æ¢å™¨ï¼Œè·¯ç”±é”®å®Œå…¨åŒ¹é…ï¼Œæ¶ˆæ¯è¢«æŠ•é€’åˆ°å¯¹åº”çš„é˜Ÿåˆ—ï¼ŒDirect äº¤æ¢å™¨æ˜¯é»˜è®¤äº¤æ¢å™¨ï¼Œå£°æ˜ä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼Œä¼šè‡ªåŠ¨ç»‘å®šåˆ°é»˜è®¤äº¤æ¢å™¨ï¼Œä¾‹å¦‚ A é˜Ÿåˆ—ç»‘å®šè·¯ç”±é”® `routing key = juzi`ï¼Œé‚£ä¹ˆåªæœ‰è·¯ç”±é”®ä¸º `juzi` çš„æ¶ˆæ¯å¯ä»¥è¿›å…¥Aé˜Ÿåˆ—ã€‚

`Fanout Exchange`

å¹¿æ’­äº¤æ¢å™¨ï¼Œæ¶ˆæ¯å¹¿æ’­åˆ°ç»‘å®šçš„é˜Ÿåˆ—ï¼Œä¸ç®¡é˜Ÿåˆ—ç»‘å®šäº†ä»€ä¹ˆè·¯ç”±é”®ï¼Œæ¶ˆæ¯ç»è¿‡äº¤æ¢å™¨ï¼Œæ¯ä¸ªé˜Ÿåˆ—éƒ½æœ‰ä¸€ä»½ã€‚

`Topic Exchange`

ä¸»é¢˜äº¤æ¢å™¨ï¼Œé€šè¿‡è·¯ç”±é”®é…ç½®è§„åˆ™è½¬å‘åˆ°é˜Ÿåˆ—ï¼Œä½¿ç”¨ `*` å’Œ `#` é€šé…ç¬¦è¿›è¡Œå¤„ç†ï¼Œä½¿æ¥è‡ªä¸åŒæºå¤´çš„æ¶ˆæ¯åˆ°è¾¾åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œ`.` å°†è·¯ç”±é”®åˆ†ä¸ºäº†å‡ ä¸ªæ ‡è¯†ç¬¦ï¼Œ`*` åŒ¹é… 1 ä¸ªï¼Œ`#` åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªã€‚

::: tip Topic Exchange è¯´æ˜

- Aé˜Ÿåˆ—ç»‘å®šäº†è·¯ç”±é”® `routing key = juzi.*` ã€‚
- Bé˜Ÿåˆ—ç»‘å®šäº†è·¯ç”±é”® `routing key = juzi.#` ã€‚
- é‚£ä¹ˆè·¯ç”±é”®ä¸º `juzi.t1` çš„æ¶ˆæ¯ä¼šåŒæ—¶è¿›å…¥ Aï¼ŒB é˜Ÿåˆ—ã€‚
- è·¯ç”±é”®ä¸º `juzi.t1.t2` çš„æ¶ˆæ¯åªä¼šè¿›å…¥ B é˜Ÿåˆ—ã€‚

:::

## å®‰è£…

ä½¿ç”¨ Docker å¿«é€Ÿå®‰è£…ã€‚

```bash
docker run -d --restart=always --hostname rabbitmq-host \
--name rabbitmq \
-e RABBITMQ_DEFAULT_USER='ä½ çš„ç”¨æˆ·å' \
-e RABBITMQ_DEFAULT_PASS='ä½ çš„å¯†ç ' \
-v /juzi/dockerData/rabbitmq:/var/lib/rabbitmq \
-p 5672:5672 -p 15672:15672 \
rabbitmq:3.11-management
```

## javaå®¢æˆ·ç«¯åŸºç¡€ä½¿ç”¨

![é˜Ÿåˆ—æ•™ç¨‹](https://juzicoding.com/img/2025/01KDQD3M5BCSZAZ8K3GWXNFXM2.webp)

å®˜ç½‘ä»‹ç»äº†ä»¥ä¸Šå‡ ç§é˜Ÿåˆ—çš„ä½¿ç”¨ï¼Œæˆ‘è¿™é‡Œå…ˆé€‰å–å‡ ä¸ªå¸¸ç”¨çš„æ¥å­¦ä¹ ä¸€ä¸‹ã€‚

åˆ›å»º maven é¡¹ç›®ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ã€‚

```text
ğŸ“¦ rabbitmq-base
â”œâ”€ ğŸ“‚ src
â”‚  â””â”€ ğŸ“‚ main
â”‚     â”œâ”€ ğŸ“‚ java
â”‚     â”‚  â””â”€ ğŸ“¦ com.juzicoding
â”‚     â”‚     â”œâ”€ ğŸ“¦ config
â”‚     â”‚     â”‚  â””â”€ â˜• RabbitConstant.java
â”‚     â”‚     â”œâ”€ ğŸ“¦ confirms
â”‚     â”‚     â”‚  â”œâ”€ â˜• Producer1.java
â”‚     â”‚     â”‚  â”œâ”€ â˜• Producer2.java
â”‚     â”‚     â”‚  â””â”€ â˜• Producer3.java
â”‚     â”‚     â”œâ”€ ğŸ“¦ direct
â”‚     â”‚     â”‚  â”œâ”€ â˜• Consumer.java
â”‚     â”‚     â”‚  â””â”€ â˜• Producer.java
â”‚     â”‚     â”œâ”€ ğŸ“¦ fanout
â”‚     â”‚     â”‚  â”œâ”€ â˜• Consumer1.java
â”‚     â”‚     â”‚  â”œâ”€ â˜• Consumer2.java
â”‚     â”‚     â”‚  â””â”€ â˜• Producer.java
â”‚     â”‚     â”œâ”€ ğŸ“¦ topic
â”‚     â”‚     â”‚  â”œâ”€ â˜• Consumer.java
â”‚     â”‚     â”‚  â””â”€ â˜• Producer.java
â”‚     â”‚     â””â”€ ğŸ“¦ work
â”‚     â”‚        â”œâ”€ â˜• Producer.java
â”‚     â”‚        â”œâ”€ â˜• PullModeConsumer.java
â”‚     â”‚        â””â”€ â˜• PushModeConsumer.java
â”‚     â””â”€ ğŸ“‚ resources
â””â”€ ğŸ“„ pom.xml
```

`pom.xml` å¼•å…¥ä¾èµ–ï¼Œ`amqp-client` ä¸ºæˆ‘ä»¬éœ€è¦è¿æ¥ä½¿ç”¨ RabbitMQ çš„ä¾èµ–ï¼Œå…¶ä»–çš„ä¸ºä¸ªäººä½¿ç”¨ä¹ æƒ¯ã€‚

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <!-- é¡¹ç›®åŸºæœ¬ä¿¡æ¯ -->
    <groupId>com.juzicoding</groupId>
    <artifactId>rabbitmq-base</artifactId>
    <version>1.0-SNAPSHOT</version>

    <!-- å…¨å±€å±æ€§é…ç½® -->
    <properties>
        <maven.compiler.source>21</maven.compiler.source>
        <maven.compiler.target>21</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <!-- ä¾èµ–ç®¡ç† -->
    <dependencies>
        <!-- RabbitMQ Javaå®¢æˆ·ç«¯ -->
        <dependency>
            <groupId>com.rabbitmq</groupId>
            <artifactId>amqp-client</artifactId>
            <version>5.25.0</version>
        </dependency>

        <!-- æ—¥å¿—æ¥å£ -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>2.0.16</version>
        </dependency>

        <!-- æ—¥å¿—å®ç° -->
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
            <version>1.5.18</version>
            <scope>compile</scope>
        </dependency>

        <!-- ç®€åŒ–ä»£ç å¼€å‘ -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.40</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>
</project>
```

ç„¶åé€šç”¨é…ç½®å¸¸é‡æ”¾åœ¨ä¸€ä¸ªç±»é‡Œé¢ã€‚

```java
public class RabbitConstant {

    // RabbitMQ ip
    public static final String HOST_NAME = "127.0.0.1";
    // RabbitMQ ç«¯å£
    public static final int HOST_PORT = 5672;
    // RabbitMQ è´¦å·
    public static final String USER_NAME = "juzi";
    // RabbitMQ å¯†ç 
    public static final String PASSWORD = "juzi123456";
    // è™šæ‹Ÿç©ºé—´
    public static final String VIRTUAL_HOST = "/juzi";

    // Work Queues
    public static final String WORK_QUEUE_NAME = "workQueue";

    // Publish/Subscribe
    public static final String FANOUT_QUEUE1_NAME = "fanoutQueue1";
    public static final String FANOUT_QUEUE2_NAME = "fanoutQueue2";
    public static final String FANOUT_EXCHANGE_NAME = "fanoutExchange";

    // Direct
    public static final String DIRECT_QUEUE_NAME = "directQueue";
    public static final String DIRECT_EXCHANGE_NAME = "directExchange";
    public static final String DIRECT_ROUTE_KEY = "directRouteKey";

    // Topics
    public static final String TOPIC_QUEUE_NAME = "topicQueue";
    public static final String TOPIC_EXCHANGE_NAME = "topicExchange";
    public static final String TOPIC_ROUTE_KEY = "juzi.*";

    // Publisher Confirms
    public static final String CONFIRMS_QUEUE = "confirmsQueue";

}
```

ç®€å•æ¥è¯´ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚

- é¦–å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channelã€‚
- å£°æ˜ Exchangeã€‚
- å£°æ˜ Queueã€‚
- å£°æ˜ Exchange ä¸ Queue çš„ç»‘å®šå…³ç³»ã€‚
- Producer å‘é€æ¶ˆæ¯åˆ° Queueã€‚
- Consumer æ¶ˆè´¹æ¶ˆæ¯ã€‚
- å®Œæˆä»¥åå…³é—­è¿æ¥ï¼Œé‡Šæ”¾èµ„æºã€‚

### Work Queue æ¨¡å‹

![image-20251231155932438](https://juzicoding.com/img/2025/01KDSPPQ229C7ZNYMDGZWPERQ4.webp)

è¿™æ˜¯ RabbitMQ æœ€åŸºç¡€ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§å·¥ä½œæœºåˆ¶ï¼Œç”Ÿäº§è€…ç›´æ¥å°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ï¼Œç„¶åç”±å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚

#### æ¶ˆæ¯å‘é€

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Producer {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // å£°æ˜é˜Ÿåˆ—; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, æ˜¯å¦æŒä¹…åŒ–, æ˜¯å¦æ’ä»–æ€§, æ˜¯å¦è‡ªåŠ¨åˆ é™¤, å…¶ä»–å‚æ•°
            channel.queueDeclare(RabbitConstant.WORK_QUEUE_NAME, true, false, false, null);
            // å‘é€æ¶ˆæ¯
            String msg = "Hello RabbitMQ!";
            // String msg = "error msg.";
            channel.basicPublish("", RabbitConstant.WORK_QUEUE_NAME, null, msg.getBytes(StandardCharsets.UTF_8));
            log.info("å‘é€æˆåŠŸï¼š{}", msg);
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }
}
```



#### æ¶ˆè´¹æ¶ˆè´¹

æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯æœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯æ¨æ¨¡å¼ï¼ˆMQ æŠŠæ¶ˆæ¯æ¨é€ç»™æ¶ˆè´¹è€…ï¼‰ï¼Œä¸€ç§æ˜¯æ‹‰æ¨¡å¼ï¼ˆæ¶ˆè´¹è€…ä» MQ æ‹¿æ¶ˆæ¯ï¼‰ï¼Œè¿™é‡Œæ¥çœ‹çœ‹ä¸¤ç§æ¨¡å¼çš„ä½¿ç”¨ã€‚

**æ¨æ¨¡å¼**

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.DeliverCallback;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class PushModeConsumer {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        try {
            // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
            Connection connection = factory.newConnection();
            Channel channel = connection.createChannel();
            // å£°æ˜é˜Ÿåˆ—
            channel.queueDeclare(RabbitConstant.WORK_QUEUE_NAME, true, false, false, null);
            // ä¸è‡ªåŠ¨ç¡®è®¤
            boolean autoAck = false;
            // æ¶ˆæ¯å¤„ç†é€»è¾‘
            DeliverCallback deliverCallback = (consumerTag, delivery) -> {
                String message = new String(delivery.getBody(), StandardCharsets.UTF_8);
                long deliveryTag = delivery.getEnvelope().getDeliveryTag();
                try {
                    log.info("æ”¶åˆ°æ¶ˆæ¯: {}", message);

                    // æ¨¡æ‹Ÿå¤„ç†ä¸šåŠ¡é€»è¾‘
                    if (message.contains("error")) {
                        throw new RuntimeException("æ¨¡æ‹Ÿä¸šåŠ¡å¼‚å¸¸");
                    }

                    // æ‰‹åŠ¨ç¡®è®¤; å‚æ•°å«ä¹‰: æ¶ˆæ¯æ ‡è¯†, æ˜¯å¦æ‰¹é‡ç¡®è®¤(false: åªç¡®è®¤å½“å‰è¿™ä¸€æ¡æ¶ˆæ¯, true: ç¡®è®¤æ‰€æœ‰å°äºç­‰äºè¯¥ deliveryTag çš„æ¶ˆæ¯)
                    channel.basicAck(deliveryTag, false);
                    log.info("æ¶ˆæ¯æ‰‹åŠ¨ç¡®è®¤");
                } catch (Exception e) {
                    log.error(e.getMessage(), e);
                    // å•æ¡æ¶ˆæ¯ï¼Œé‡æ–°æŠ•é€’ channel.basicNack(deliveryTag, false, true);
                    // å•æ¡æ¶ˆæ¯ï¼Œç›´æ¥ä¸¢å¼ƒ channel.basicNack(deliveryTag, false, false);
                    channel.basicNack(deliveryTag, false, true);
                }
            };
            // å¯åŠ¨æ¶ˆè´¹è€…
            channel.basicConsume(RabbitConstant.WORK_QUEUE_NAME, autoAck, deliverCallback, consumerTag -> {
            });
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



**æ‹‰æ¨¡å¼**

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.GetResponse;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class PullModeConsumer {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // å£°æ˜é˜Ÿåˆ—
            channel.queueDeclare(RabbitConstant.WORK_QUEUE_NAME, true, false, false, null);
            // æ‹‰å–æ¶ˆæ¯
            GetResponse res = channel.basicGet(RabbitConstant.WORK_QUEUE_NAME, false);
            if (res == null) {
                log.info("æ²¡æœ‰éœ€è¦æ¶ˆè´¹çš„æ¶ˆæ¯");
                return;
            }
            String message = new String(res.getBody(), StandardCharsets.UTF_8);
            log.info("æ”¶åˆ°æ¶ˆæ¯: {}", message);
            // æ‰‹åŠ¨ç¡®è®¤
            channel.basicAck(res.getEnvelope().getDeliveryTag(), false);
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



é€šå¸¸æƒ…å†µä¸‹æ¨èä½¿ç”¨æ¨æ¨¡å¼ï¼ŒRabbitMQ çš„æ¶æ„æ›´ä¾§é‡äºé«˜æ•ˆçš„â€œæ¨æ¨¡å¼â€ï¼Œè¿™ä¹Ÿæ˜¯å…¶ä½œä¸ºå¼‚æ­¥æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿçš„æ ‡å‡†ç”¨æ³•ã€‚è€Œâ€œæ‹‰æ¨¡å¼â€æ›´åƒæ˜¯ä¸€ä¸ªè¾…åŠ©åŠŸèƒ½ï¼Œç”¨äºç‰¹å®šåœºæ™¯ã€‚

| ç‰¹æ€§         | æ¨æ¨¡å¼ (`basic.consume`)                                     | æ‹‰æ¨¡å¼ (`basic.get`)                                         |
| :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **ä¸»åŠ¨æ€§**   | RabbitMQ ä¸»åŠ¨                                                | æ¶ˆè´¹è€…ä¸»åŠ¨                                                   |
| **å®æ—¶æ€§**   | **é«˜**ã€‚æ¶ˆæ¯ä¸€åˆ°ç«‹å³æ¨é€ã€‚                                   | **ä½**ã€‚å–å†³äºè½®è¯¢é—´éš”ã€‚                                     |
| **æ€§èƒ½å¼€é”€** | é•¿è¿æ¥ï¼Œæ¨é€å³æ—¶ï¼Œ**æ•ˆç‡é«˜**ï¼Œæ˜¯æ¨èæ–¹å¼ã€‚                   | é¢‘ç¹è½®è¯¢ä¼šäº§ç”Ÿä¸å¿…è¦çš„è¯·æ±‚ï¼ˆå³ä½¿é˜Ÿåˆ—ä¸ºç©ºï¼‰ï¼Œ**æ•ˆç‡è¾ƒä½**ã€‚   |
| **æµé‡æ§åˆ¶** | **æ”¯æŒå¥½**ã€‚é€šè¿‡ `prefetch_count` å‚æ•°é™åˆ¶æœªç¡®è®¤æ¶ˆæ¯çš„æ•°é‡ï¼Œå®ç°èƒŒå‹ã€‚ | **ä¸æ”¯æŒ**ã€‚æ¯æ¬¡ `get` åªèƒ½è·å–ä¸€æ¡ï¼Œæµé‡æ§åˆ¶éœ€è‡ªè¡Œåœ¨åº”ç”¨å±‚å®ç°ã€‚ |
| **è¿æ¥å¼€é”€** | ä¸€ä¸ªé•¿è¿æ¥ï¼ŒæŒç»­æ¥æ”¶ã€‚                                       | å¯ä»¥æŒ‰éœ€å»ºç«‹çŸ­è¿æ¥ï¼Œä½†é€šå¸¸ä¸å»ºè®®é¢‘ç¹å¼€å…³è¿æ¥ã€‚               |
| **ä½¿ç”¨åœºæ™¯** | **ç»å¤§å¤šæ•°åœºæ™¯**ï¼ŒæŒç»­å¤„ç†æ¶ˆæ¯ã€‚                             | **ç‰¹æ®Šåœºæ™¯**ï¼Œå¦‚ï¼šæ‰¹å¤„ç†ã€æŒ‰éœ€è¡¥å•ã€ç®¡ç†åå°æ‰‹åŠ¨è§¦å‘ç­‰ä¸è¿ç»­çš„ä»»åŠ¡ã€‚ |

### Fanout äº¤æ¢æœº

![image-20251231160000832](https://juzicoding.com/img/2025/01KDSPQJP8BC7TE1GTMKY4AX9W.webp)

Fanout ç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯ â€œæ‰‡å‡ºâ€ï¼Œä½†æ˜¯ä¸ªäººè®¤ä¸ºå«å¹¿æ’­äº¤æ¢æœºæ›´åˆé€‚ï¼Œä»–çš„ä½œç”¨å°±æ˜¯å°†æ”¶åˆ°çš„æ¶ˆæ¯å‘æ‰€æœ‰ç»‘å®šåˆ° Fanout äº¤æ¢æœºçš„é˜Ÿåˆ—è·¯ç”±ã€‚

#### æ¶ˆæ¯å‘é€

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Producer {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // å£°æ˜ fanout äº¤æ¢æœº
            channel.exchangeDeclare(RabbitConstant.FANOUT_EXCHANGE_NAME, "fanout");
            // å‘é€æ¶ˆæ¯
            String msg = "fanout err msg!";
            channel.basicPublish(RabbitConstant.FANOUT_EXCHANGE_NAME, "", null, msg.getBytes(StandardCharsets.UTF_8));
            log.info("å‘é€æˆåŠŸï¼š{}", msg);
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }
}
```



#### æ¶ˆè´¹æ¶ˆè´¹

**æ¶ˆè´¹è€…1**

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.DeliverCallback;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Consumer1 {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        try {
            // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
            Connection connection = factory.newConnection();
            Channel channel = connection.createChannel();
            // å£°æ˜äº¤æ¢æœº
            channel.exchangeDeclare(RabbitConstant.FANOUT_EXCHANGE_NAME, "fanout");
            // å£°æ˜é˜Ÿåˆ—
            channel.queueDeclare(RabbitConstant.FANOUT_QUEUE1_NAME, true, false, false, null);
            // å£°æ˜äº¤æ¢æœºä¸é˜Ÿåˆ—çš„ç»‘å®šå…³ç³»; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, äº¤æ¢æœºå, è·¯ç”±key
            channel.queueBind(RabbitConstant.FANOUT_QUEUE1_NAME, RabbitConstant.FANOUT_EXCHANGE_NAME, "");
            // ä¸è‡ªåŠ¨ç¡®è®¤
            boolean autoAck = false;
            // æ¶ˆæ¯å¤„ç†é€»è¾‘
            DeliverCallback deliverCallback = (consumerTag, delivery) -> {
                String msg = new String(delivery.getBody(), StandardCharsets.UTF_8);
                long deliveryTag = delivery.getEnvelope().getDeliveryTag();
                try {
                    log.info("Consumer1 æ”¶åˆ°æ¶ˆæ¯: {}", msg);
                    // æ¨¡æ‹Ÿå¤„ç†ä¸šåŠ¡é€»è¾‘
                    if (msg.contains("error")) {
                        throw new RuntimeException("æ¨¡æ‹Ÿä¸šåŠ¡å¼‚å¸¸");
                    }
                    // æ‰‹åŠ¨ç¡®è®¤; å‚æ•°å«ä¹‰: æ¶ˆæ¯æ ‡è¯†, æ˜¯å¦æ‰¹é‡ç¡®è®¤(false: åªç¡®è®¤å½“å‰è¿™ä¸€æ¡æ¶ˆæ¯, true: ç¡®è®¤æ‰€æœ‰å°äºç­‰äºè¯¥ deliveryTag çš„æ¶ˆæ¯)
                    channel.basicAck(deliveryTag, false);
                    log.info("æ¶ˆæ¯æ‰‹åŠ¨ç¡®è®¤");
                } catch (Exception e) {
                    log.error(e.getMessage(), e);
                    // channel.basicNack(deliveryTag, false, true);  // å•æ¡æ¶ˆæ¯ï¼Œé‡æ–°æŠ•é€’
                    // channel.basicNack(deliveryTag, false, false); // å•æ¡æ¶ˆæ¯ï¼Œç›´æ¥ä¸¢å¼ƒ
                    channel.basicNack(deliveryTag, false, false);
                }
            };
            // å¯åŠ¨æ¶ˆè´¹è€…
            channel.basicConsume(RabbitConstant.FANOUT_QUEUE1_NAME, autoAck, deliverCallback, consumerTag -> {
            });
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



**æ¶ˆè´¹è€…2**

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.DeliverCallback;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Consumer2 {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        try {
            // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
            Connection connection = factory.newConnection();
            Channel channel = connection.createChannel();
            // å£°æ˜äº¤æ¢æœº
            channel.exchangeDeclare(RabbitConstant.FANOUT_EXCHANGE_NAME, "fanout");
            // å£°æ˜é˜Ÿåˆ—
            channel.queueDeclare(RabbitConstant.FANOUT_QUEUE2_NAME, true, false, false, null);
            // å£°æ˜äº¤æ¢æœºä¸é˜Ÿåˆ—çš„ç»‘å®šå…³ç³»; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, äº¤æ¢æœºå, è·¯ç”±key
            channel.queueBind(RabbitConstant.FANOUT_QUEUE2_NAME, RabbitConstant.FANOUT_EXCHANGE_NAME, "");
            // ä¸è‡ªåŠ¨ç¡®è®¤
            boolean autoAck = false;
            // æ¶ˆæ¯å¤„ç†é€»è¾‘
            DeliverCallback deliverCallback = (consumerTag, delivery) -> {
                String msg = new String(delivery.getBody(), StandardCharsets.UTF_8);
                long deliveryTag = delivery.getEnvelope().getDeliveryTag();
                try {
                    log.info("Consumer2 æ”¶åˆ°æ¶ˆæ¯: {}", msg);
                    // æ¨¡æ‹Ÿå¤„ç†ä¸šåŠ¡é€»è¾‘
                    if (msg.contains("error")) {
                        throw new RuntimeException("æ¨¡æ‹Ÿä¸šåŠ¡å¼‚å¸¸");
                    }
                    // æ‰‹åŠ¨ç¡®è®¤; å‚æ•°å«ä¹‰: æ¶ˆæ¯æ ‡è¯†, æ˜¯å¦æ‰¹é‡ç¡®è®¤(false: åªç¡®è®¤å½“å‰è¿™ä¸€æ¡æ¶ˆæ¯, true: ç¡®è®¤æ‰€æœ‰å°äºç­‰äºè¯¥ deliveryTag çš„æ¶ˆæ¯)
                    channel.basicAck(deliveryTag, false);
                    log.info("æ¶ˆæ¯æ‰‹åŠ¨ç¡®è®¤");
                } catch (Exception e) {
                    log.error(e.getMessage(), e);
                    // channel.basicNack(deliveryTag, false, true);  // å•æ¡æ¶ˆæ¯ï¼Œé‡æ–°æŠ•é€’
                    // channel.basicNack(deliveryTag, false, false); // å•æ¡æ¶ˆæ¯ï¼Œç›´æ¥ä¸¢å¼ƒ
                    channel.basicNack(deliveryTag, false, false);
                }
            };
            // å¯åŠ¨æ¶ˆè´¹è€…
            channel.basicConsume(RabbitConstant.FANOUT_QUEUE2_NAME, autoAck, deliverCallback, consumerTag -> {
            });
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}

```



### Direct äº¤æ¢æœº

![image-20251231160037335](https://juzicoding.com/img/2025/01KDSPRP9YXYVWQT27T2SMD0ZK.webp)

å¯¹æ¯” Fanout äº¤æ¢æœºçš„å¹¿æ’­æŠ•é€’ï¼ŒDirect äº¤æ¢æœºæ ¹æ®æ¶ˆæ¯çš„è·¯ç”±é”®ï¼ˆRouting Keyï¼‰å°†æ¶ˆæ¯ç²¾ç¡®åœ°æŠ•é€’åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚

#### æ¶ˆæ¯å‘é€

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Producer {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // å£°æ˜äº¤æ¢æœº; å‚æ•°å«ä¹‰: äº¤æ¢æœºåç§°, äº¤æ¢æœºç±»å‹, æ˜¯å¦æŒä¹…åŒ–
            channel.exchangeDeclare(RabbitConstant.DIRECT_EXCHANGE_NAME, "direct", true);
            // å£°æ˜é˜Ÿåˆ—; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, æ˜¯å¦æŒä¹…åŒ–, æ˜¯å¦æ’ä»–æ€§, æ˜¯å¦è‡ªåŠ¨åˆ é™¤, å…¶ä»–å‚æ•°
            channel.queueDeclare(RabbitConstant.DIRECT_QUEUE_NAME, true, false, false, null);
            // å£°æ˜äº¤æ¢æœºä¸é˜Ÿåˆ—çš„ç»‘å®šå…³ç³»; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, äº¤æ¢æœºå, è·¯ç”±key
            channel.queueBind(RabbitConstant.DIRECT_QUEUE_NAME, RabbitConstant.DIRECT_EXCHANGE_NAME, RabbitConstant.DIRECT_ROUTE_KEY);
            // å‘é€æ¶ˆæ¯
            String msg = "direct msg!";
            channel.basicPublish(RabbitConstant.DIRECT_EXCHANGE_NAME, RabbitConstant.DIRECT_ROUTE_KEY, null, msg.getBytes(StandardCharsets.UTF_8));
            log.info("å‘é€æˆåŠŸï¼š{}", msg);
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



#### æ¶ˆè´¹æ¶ˆè´¹

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.DeliverCallback;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Consumer {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        try {
            // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
            Connection connection = factory.newConnection();
            Channel channel = connection.createChannel();
            // å£°æ˜é˜Ÿåˆ—
            channel.queueDeclare(RabbitConstant.DIRECT_QUEUE_NAME, true, false, false, null);
            // ä¸è‡ªåŠ¨ç¡®è®¤
            boolean autoAck = false;
            // æ¶ˆæ¯å¤„ç†é€»è¾‘
            DeliverCallback deliverCallback = (consumerTag, delivery) -> {
                String msg = new String(delivery.getBody(), StandardCharsets.UTF_8);
                long deliveryTag = delivery.getEnvelope().getDeliveryTag();
                try {
                    log.info("æ”¶åˆ°æ¶ˆæ¯: {}", msg);
                    // æ¨¡æ‹Ÿå¤„ç†ä¸šåŠ¡é€»è¾‘
                    if (msg.contains("error")) {
                        throw new RuntimeException("æ¨¡æ‹Ÿä¸šåŠ¡å¼‚å¸¸");
                    }
                    // æ‰‹åŠ¨ç¡®è®¤; å‚æ•°å«ä¹‰: æ¶ˆæ¯æ ‡è¯†, æ˜¯å¦æ‰¹é‡ç¡®è®¤(false: åªç¡®è®¤å½“å‰è¿™ä¸€æ¡æ¶ˆæ¯, true: ç¡®è®¤æ‰€æœ‰å°äºç­‰äºè¯¥ deliveryTag çš„æ¶ˆæ¯)
                    channel.basicAck(deliveryTag, false);
                    log.info("æ¶ˆæ¯æ‰‹åŠ¨ç¡®è®¤");
                } catch (Exception e) {
                    log.error(e.getMessage(), e);
                    // channel.basicNack(deliveryTag, false, true);  // å•æ¡æ¶ˆæ¯ï¼Œé‡æ–°æŠ•é€’
                    // channel.basicNack(deliveryTag, false, false); // å•æ¡æ¶ˆæ¯ï¼Œç›´æ¥ä¸¢å¼ƒ
                    channel.basicNack(deliveryTag, false, false);
                }
            };

            // å¯åŠ¨æ¶ˆè´¹è€…
            channel.basicConsume(RabbitConstant.DIRECT_QUEUE_NAME, autoAck, deliverCallback, consumerTag -> {
            });
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



### Topic äº¤æ¢æœº

![image-20251231160101485](https://juzicoding.com/img/2025/01KDSPSDYEQYZ6B4236PWPS3TN.webp)

Topic ä¸ Direct ç›¸æ¯”éƒ½æ˜¯å¯ä»¥æ ¹æ®è·¯ç”±é”®æŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ï¼Œåªä¸è¿‡ Topic å¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®šè·¯ç”±é”®çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼Œè¿™æ ·å°±å¯ä»¥è·¯ç”±ä¸€ç±»æ¶ˆæ¯ã€‚

#### æ¶ˆæ¯å‘é€

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Producer {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            // å£°æ˜äº¤æ¢æœº; å‚æ•°å«ä¹‰: äº¤æ¢æœºåç§°, äº¤æ¢æœºç±»å‹, æ˜¯å¦æŒä¹…åŒ–
            channel.exchangeDeclare(RabbitConstant.TOPIC_EXCHANGE_NAME, "topic", true);
            // å£°æ˜é˜Ÿåˆ—; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, æ˜¯å¦æŒä¹…åŒ–, æ˜¯å¦æ’ä»–æ€§, æ˜¯å¦è‡ªåŠ¨åˆ é™¤, å…¶ä»–å‚æ•°
            channel.queueDeclare(RabbitConstant.TOPIC_QUEUE_NAME, true, false, false, null);
            // å£°æ˜äº¤æ¢æœºä¸é˜Ÿåˆ—çš„ç»‘å®šå…³ç³»; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, äº¤æ¢æœºå, è·¯ç”±key
            channel.queueBind(RabbitConstant.TOPIC_QUEUE_NAME, RabbitConstant.TOPIC_EXCHANGE_NAME, RabbitConstant.TOPIC_ROUTE_KEY);
            // å‘é€æ¶ˆæ¯
            String msg = "topic msg!";
            channel.basicPublish(RabbitConstant.TOPIC_EXCHANGE_NAME, "juzi.coding", null, msg.getBytes(StandardCharsets.UTF_8));
            log.info("å‘é€æˆåŠŸï¼š{}", msg);
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



#### æ¶ˆè´¹æ¶ˆè´¹

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.DeliverCallback;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Consumer {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        try {
            // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
            Connection connection = factory.newConnection();
            Channel channel = connection.createChannel();
            // å£°æ˜é˜Ÿåˆ—
            channel.queueDeclare(RabbitConstant.TOPIC_QUEUE_NAME, true, false, false, null);
            // ä¸è‡ªåŠ¨ç¡®è®¤
            boolean autoAck = false;
            // æ¶ˆæ¯å¤„ç†é€»è¾‘
            DeliverCallback deliverCallback = (consumerTag, delivery) -> {
                String msg = new String(delivery.getBody(), StandardCharsets.UTF_8);
                long deliveryTag = delivery.getEnvelope().getDeliveryTag();
                try {
                    log.info("æ”¶åˆ°æ¶ˆæ¯: {}", msg);
                    // æ¨¡æ‹Ÿå¤„ç†ä¸šåŠ¡é€»è¾‘
                    if (msg.contains("error")) {
                        throw new RuntimeException("æ¨¡æ‹Ÿä¸šåŠ¡å¼‚å¸¸");
                    }
                    // æ‰‹åŠ¨ç¡®è®¤; å‚æ•°å«ä¹‰: æ¶ˆæ¯æ ‡è¯†, æ˜¯å¦æ‰¹é‡ç¡®è®¤(false: åªç¡®è®¤å½“å‰è¿™ä¸€æ¡æ¶ˆæ¯, true: ç¡®è®¤æ‰€æœ‰å°äºç­‰äºè¯¥ deliveryTag çš„æ¶ˆæ¯)
                    channel.basicAck(deliveryTag, false);
                    log.info("æ¶ˆæ¯æ‰‹åŠ¨ç¡®è®¤");
                } catch (Exception e) {
                    log.error(e.getMessage(), e);
                    // channel.basicNack(deliveryTag, false, true);  // å•æ¡æ¶ˆæ¯ï¼Œé‡æ–°æŠ•é€’
                    // channel.basicNack(deliveryTag, false, false); // å•æ¡æ¶ˆæ¯ï¼Œç›´æ¥ä¸¢å¼ƒ
                    channel.basicNack(deliveryTag, false, false);
                }
            };

            // å¯åŠ¨æ¶ˆè´¹è€…
            channel.basicConsume(RabbitConstant.TOPIC_QUEUE_NAME, autoAck, deliverCallback, consumerTag -> {
            });
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



### ç”Ÿäº§è€…ç¡®è®¤

RabbitMQ è™½ç„¶èƒ½ä¿è¯æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—åçš„å¯é æ€§ï¼Œä½†åœ¨æ¶ˆæ¯å‘é€é˜¶æ®µå¯èƒ½å­˜åœ¨é£é™©ã€‚å›é¡¾åŸºç¡€çš„ `channel.basicPublish` æ–¹æ³•ï¼Œä½ ä¼šå‘ç°å®ƒæ²¡æœ‰è¿”å›å€¼â€”â€”è¿™æ„å‘³ç€å‘é€è€…æ— æ³•ç¡®è®¤æ¶ˆæ¯æ˜¯å¦æˆåŠŸåˆ°è¾¾ RabbitMQã€‚è¿™åœ¨ä¸šåŠ¡å±‚é¢å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œä¸ç¨³å®šæˆ–æœåŠ¡å¼‚å¸¸æ—¶ã€‚

ä¸ºäº†å¡«è¡¥è¿™ä¸ªå¯é æ€§ç¼ºå£ï¼ŒRabbitMQ æä¾›äº†å‘é€è€…ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmsï¼‰ã€‚è¯¥æœºåˆ¶é€šè¿‡å¼‚æ­¥ç¡®è®¤çš„æ–¹å¼ï¼Œè®©ç”Ÿäº§è€…èƒ½å¤Ÿå¯é åœ°çŸ¥æ™“æ¶ˆæ¯æ˜¯å¦å·²è¢« MQ æœåŠ¡å™¨æˆåŠŸæ¥æ”¶å’Œå¤„ç†ã€‚

è¿™ä¸ªæœºåˆ¶é»˜è®¤æƒ…å†µä¸‹æ˜¯å…³é—­çš„ï¼Œå®˜ç½‘ä¸»è¦ä»‹ç»äº†3ç§æ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆå¼€å¯è¿™ä¸ªæœºåˆ¶çš„ä½¿ç”¨ã€‚

#### æ™®é€šç¡®è®¤æ¨¡å¼

ç®€å•æ¥è¯´ï¼Œå½“å‘é€ä¸€æ¡æ¶ˆæ¯åï¼Œè°ƒç”¨ `channel.waitForConfirmsOrDie(5000L);` æ–¹æ³•ä¼šåœ¨ Channel å±‚é¢åŒæ­¥ç­‰å¾… RabbitMQ æœåŠ¡ç«¯çš„ç¡®è®¤å“åº”ï¼Œä»¥ç¡®ä¿æ¶ˆæ¯å·²æˆåŠŸé€è¾¾ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡å½“å‰ Channel ç›´åˆ°æ”¶åˆ°ç¡®è®¤æˆ–è¶…æ—¶ï¼Œåœ¨æ­¤æœŸé—´ Channel æ— æ³•ç»§ç»­å‘é€åç»­æ¶ˆæ¯ï¼Œå› æ­¤ä¼šå¯¹æ¶ˆæ¯ååé‡é€ æˆæ˜æ˜¾å½±å“ã€‚

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Producer1 {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
        try {
            Connection connection = factory.newConnection();
            Channel channel = connection.createChannel();
            // å£°æ˜é˜Ÿåˆ—; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, æ˜¯å¦æŒä¹…åŒ–, æ˜¯å¦æ’ä»–æ€§, æ˜¯å¦è‡ªåŠ¨åˆ é™¤, å…¶ä»–å‚æ•°
            channel.queueDeclare(RabbitConstant.CONFIRMS_QUEUE, true, false, false, null);
            // å¼€å¯ç”Ÿäº§è€…ç¡®è®¤æ¨¡å¼
            channel.confirmSelect();
            // å‘é€æ¶ˆæ¯
            for (int i = 0; i < 10; i++) {
                String msg = "Publisher Confirms " + i;
                channel.basicPublish("", RabbitConstant.CONFIRMS_QUEUE, null, msg.getBytes(StandardCharsets.UTF_8));
                channel.waitForConfirmsOrDie(5000L);
                log.info("æ¶ˆæ¯ç¡®è®¤æˆåŠŸ: {}", msg);
            }
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



#### æ‰¹é‡ç¡®è®¤æ¨¡å¼

ä¹‹å‰çš„å•æ¡ç¡®è®¤æœºåˆ¶ä¼šæ˜¾è‘—é™ä½ç³»ç»Ÿååé‡ï¼Œå› æ­¤ä¸€ç§æŠ˜ä¸­çš„åšæ³•æ˜¯åœ¨å‘é€ä¸€æ‰¹æ¶ˆæ¯åè¿›è¡Œæ‰¹é‡ç¡®è®¤ã€‚

è¿™ç§æ–¹å¼èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£å‘é€æ–¹ç¡®è®¤æ¨¡å¼å¯¹æ€§èƒ½çš„å½±å“ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€ä¸ªå›ºæœ‰ç¼ºé™·ï¼šå½“ç¡®è®¤å‡ºç°å¼‚å¸¸æ—¶ï¼Œå‘é€æ–¹åªèƒ½æ„ŸçŸ¥åˆ°æ•´æ‰¹æ¶ˆæ¯å­˜åœ¨é—®é¢˜ï¼Œè€Œæ— æ³•å‡†ç¡®å®šä½å…·ä½“æ˜¯å“ªä¸€æ¡æ¶ˆæ¯å‘ç”Ÿäº†å¼‚å¸¸ã€‚

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;

@Slf4j
public class Producer2 {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
        try {
            Connection connection = factory.newConnection();
            Channel channel = connection.createChannel();
            // å£°æ˜é˜Ÿåˆ—; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, æ˜¯å¦æŒä¹…åŒ–, æ˜¯å¦æ’ä»–æ€§, æ˜¯å¦è‡ªåŠ¨åˆ é™¤, å…¶ä»–å‚æ•°
            channel.queueDeclare(RabbitConstant.CONFIRMS_QUEUE, true, false, false, null);
            // å¼€å¯ç”Ÿäº§è€…ç¡®è®¤æ¨¡å¼
            channel.confirmSelect();
            // å‘é€æ¶ˆæ¯
            int batchSize = 5;
            int outstanding = 0;
            for (int i = 0; i < 24; i++) {
                String msg = "Publisher Confirms " + i;
                channel.basicPublish("", RabbitConstant.CONFIRMS_QUEUE, null, msg.getBytes(StandardCharsets.UTF_8));
                outstanding++;
                if (outstanding == batchSize) {
                    // æ‰¹é‡ç­‰å¾…ç¡®è®¤
                    channel.waitForConfirmsOrDie(5000);
                    log.info("ä¸€æ‰¹æ¶ˆæ¯ç¡®è®¤æˆåŠŸ");
                    outstanding = 0;
                }
            }
            // å‰©ä½™æ¶ˆæ¯
            if (outstanding > 0) {
                channel.waitForConfirmsOrDie(5000);
                log.info("æœ€åä¸€æ‰¹ç¡®è®¤æˆåŠŸ");
            }
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```



#### å¼‚æ­¥ç¡®è®¤æ¨¡å¼

å‰é¢ä¸¤ç§æ–¹å¼éƒ½å­˜åœ¨ä¸€å®šçš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸€æ­¥ç¡®è®¤æ¨¡å¼å°±æ˜¯æœ€ä¸ºæ¨èçš„ä¸€ä¸ªæ–¹å¼ï¼Œå…·ä½“å®ç°æ–¹å¼æ˜¯åœ¨ Channel ä¸­æ³¨å†Œç¡®è®¤ç›‘å¬å™¨æ¥å¼‚æ­¥å¤„ç†æ¶ˆæ¯çš„å‘é€ç»“æœã€‚æ ¸å¿ƒæ–¹æ³•æ˜¯ï¼š

```
channel.addConfirmListener(ConfirmCallback ackCallback, ConfirmCallback nackCallback);
```

ä¸ºä½•éœ€è¦æä¾›ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Ÿè¿™æ˜¯ç”±äº RabbitMQ ä¼šåˆ†åˆ«å¯¹æ¶ˆæ¯çš„æˆåŠŸé€è¾¾å’Œå¤±è´¥æƒ…å†µè¿›è¡Œé€šçŸ¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åŒæ—¶ä¸ºæˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µåˆ†åˆ«æ³¨å†Œå¤„ç†é€»è¾‘ã€‚

ConfirmCallback æ˜¯ä¸€ä¸ªç›‘å¬å™¨æ¥å£ï¼Œå…¶ä¸­åªåŒ…å«ä¸€ä¸ªæ–¹æ³•ï¼š

```
void handle(long sequenceNumber, boolean multiple) throws IOException;
```

æ–¹æ³•å‚æ•°è¯´æ˜ï¼š

- **sequenceNumber**ï¼šè¡¨ç¤ºæ¶ˆæ¯çš„å”¯ä¸€åºåˆ—å·ã€‚ç”±äº RabbitMQ çš„æ¶ˆæ¯ä½“æœ¬èº«åªæ˜¯äºŒè¿›åˆ¶æ•°ç»„ï¼Œå¹¶ä¸æºå¸¦åºåˆ—å·ä¿¡æ¯ï¼Œå› æ­¤å‘é€æ–¹éœ€è¦è‡ªè¡Œç»´æŠ¤æ¶ˆæ¯ä¸åºåˆ—å·ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚RabbitMQ æä¾›äº† `channel.getNextPublishSeqNo()` æ–¹æ³•æ¥ç”Ÿæˆä¸€ä¸ªå…¨å±€é€’å¢çš„åºåˆ—å·ï¼Œè¯¥åºåˆ—å·ä¼šè¢«å…³è”åˆ°ä¸‹ä¸€æ¡å³å°†å‘é€çš„æ¶ˆæ¯ä¸Šã€‚åº”ç”¨ç¨‹åºå¿…é¡»è´Ÿè´£è®°å½•å’Œç»‘å®šè¿™æ¡æ¶ˆæ¯ä¸å…¶åºåˆ—å·ã€‚
- **multiple**ï¼šè¿™æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼å‚æ•°ã€‚è‹¥ä¸º `false`ï¼Œè¡¨ç¤ºå½“å‰ä»…ç¡®è®¤äº† sequenceNumber å¯¹åº”çš„å•æ¡æ¶ˆæ¯ï¼›è‹¥ä¸º `true`ï¼Œåˆ™è¡¨ç¤º RabbitMQ ä¸€æ¬¡æ€§ç¡®è®¤äº†ä¸€æ‰¹æ¶ˆæ¯ï¼Œå³åºåˆ—å·å°äºæˆ–ç­‰äºå½“å‰ sequenceNumber çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å·²è¢«ç¡®è®¤ã€‚

```java
import com.juzicoding.config.RabbitConstant;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import lombok.extern.slf4j.Slf4j;

import java.nio.charset.StandardCharsets;
import java.util.concurrent.ConcurrentSkipListMap;

@Slf4j
public class Producer3 {

    public static void main(String[] args) {
        // â¾¸å…ˆåˆ›å»ºè¿æ¥ï¼Œè·å– Channel
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(RabbitConstant.HOST_NAME);
        factory.setPort(RabbitConstant.HOST_PORT);
        factory.setUsername(RabbitConstant.USER_NAME);
        factory.setPassword(RabbitConstant.PASSWORD);
        factory.setVirtualHost(RabbitConstant.VIRTUAL_HOST);
        // åˆ›å»ºè¿æ¥ï¼Œåˆ›å»ºé€šé“
        try {
            Connection connection = factory.newConnection();
            Channel channel = connection.createChannel();
            // å£°æ˜é˜Ÿåˆ—; å‚æ•°å«ä¹‰: é˜Ÿåˆ—å, æ˜¯å¦æŒä¹…åŒ–, æ˜¯å¦æ’ä»–æ€§, æ˜¯å¦è‡ªåŠ¨åˆ é™¤, å…¶ä»–å‚æ•°
            channel.queueDeclare(RabbitConstant.CONFIRMS_QUEUE, true, false, false, null);
            // å¼€å¯ç”Ÿäº§è€…ç¡®è®¤æ¨¡å¼
            channel.confirmSelect();
            // ä¿å­˜æœªç¡®è®¤æ¶ˆæ¯ï¼ˆdeliveryTag -> msgï¼‰
            ConcurrentSkipListMap<Long, String> confirmMap = new ConcurrentSkipListMap<>();
            // ç¡®è®¤ç›‘å¬å™¨
            channel.addConfirmListener(
                    // ACK
                    (deliveryTag, multiple) -> {
                        if (multiple) {
                            confirmMap.headMap(deliveryTag + 1).clear();
                            log.info("ACK, tag <= {}", deliveryTag);
                        } else {
                            confirmMap.remove(deliveryTag);
                            log.info("ACK, tag = {}", deliveryTag);
                        }
                    },
                    // NACK
                    (deliveryTag, multiple) -> {
                        log.error("NACK, tag={}, msg={}", deliveryTag, confirmMap.get(deliveryTag));
                        // è¿™é‡Œå¯ä»¥åšé‡å‘
                    }
            );
            // å‘é€æ¶ˆæ¯
            for (int i = 0; i < 100; i++) {
                String msg = "async-confirm-" + i;
                long nextSeqNo = channel.getNextPublishSeqNo();
                confirmMap.put(nextSeqNo, msg);
                channel.basicPublish("", RabbitConstant.CONFIRMS_QUEUE, null, msg.getBytes(StandardCharsets.UTF_8));
            }
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
    }

}
```

å®é™…ä¸Šï¼Œåœ¨å½“å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒPublisher ä¸ä»…èƒ½å¤Ÿç¡®è®¤æ¶ˆæ¯æ˜¯å¦æˆåŠŸåˆ°è¾¾ Exchangeï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥ç¡®è®¤æ¶ˆæ¯æ˜¯å¦ä» Exchange æ­£ç¡®è·¯ç”±åˆ°äº† Queueã€‚è¿™é€šè¿‡åœ¨ Channel ä¸Šæ·»åŠ ä¸€ä¸ª ReturnListener æ¥å®ç°ï¼Œå®ƒä¼šç›‘å¬åˆ°é‚£äº›è™½å·²æˆåŠŸå‘é€ä½†æœªèƒ½è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚

ä¸è¿‡åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™ç±»æƒ…å†µé€šå¸¸æºäºä»£ç å±‚é¢çš„é…ç½®é—®é¢˜ï¼ˆå¦‚ç»‘å®šé”®ä¸åŒ¹é…æˆ–é˜Ÿåˆ—ä¸å­˜åœ¨ç­‰ï¼‰ï¼Œå› æ­¤å¾€å¾€ä¸ä¼šä¸»åŠ¨å¼€å¯è¿™ä¸€ç›‘å¬æœºåˆ¶ï¼Œåç»­åœ¨è¿›é˜¶å†…å®¹ä¸­ä¹Ÿä¼šç®€å•æåˆ°ã€‚

## SpringBoot é›†æˆ

æœ‰äº†å‰é¢çš„åŸºç¡€ï¼Œé›†æˆåˆ° SpringBoot å°±æ›´ç®€å•äº†ï¼Œä¹Ÿæ˜¯å·®ä¸å¤šçš„æ­¥éª¤ï¼Œæˆ‘ä¸å†™æ³¨é‡Šéƒ½èƒ½çœ‹æ‡‚çš„é‚£ç§ã€‚

å…ˆåˆ›å»ºé¡¹ç›®ï¼Œrabbitmq-springboot ä¸ºçˆ¶é¡¹ç›®ï¼Œç»Ÿä¸€é€šç”¨ä¾èµ–åŠç‰ˆæœ¬ï¼›mq-producer ä¸ºç”Ÿäº§è€…é¡¹ç›®ï¼Œå¯åŠ¨ç«¯å£ 8080ï¼›mq-consumer ä¸ºæ¶ˆè´¹è€…é¡¹ç›®ï¼Œå¯åŠ¨ç«¯å£ 8081ã€‚

```text
ğŸ“¦ rabbitmq-springboot
â”œâ”€ ğŸ“¦ mq-consumer
â”‚  â”œâ”€ ğŸ“‚ src
â”‚  â”‚  â”œâ”€ ğŸ“‚ main
â”‚  â”‚  â”‚  â”œâ”€ ğŸ“‚ java
â”‚  â”‚  â”‚  â”‚  â””â”€ ğŸ“¦ com.juzicoding
â”‚  â”‚  â”‚  â”‚     â”œâ”€ ğŸ“¦ constant
â”‚  â”‚  â”‚  â”‚     â”‚  â””â”€ â˜• RabbitConstant.java
â”‚  â”‚  â”‚  â”‚     â”œâ”€ ğŸ“¦ consumer
â”‚  â”‚  â”‚  â”‚     â”‚  â”œâ”€ â˜• DirectConsumer.java
â”‚  â”‚  â”‚  â”‚     â”‚  â”œâ”€ â˜• FanoutConsumer.java
â”‚  â”‚  â”‚  â”‚     â”‚  â”œâ”€ â˜• TopicConsumer.java
â”‚  â”‚  â”‚  â”‚     â”‚  â””â”€ â˜• WorkQueueConsumer.java
â”‚  â”‚  â”‚  â”‚     â””â”€ â˜• MqConsumerApplication.java
â”‚  â”‚  â”‚  â””â”€ ğŸ“‚ resources
â”‚  â”‚  â”‚     â””â”€ âš™ï¸ application.yml
â”‚  â””â”€ ğŸ“„ pom.xml
â”œâ”€ ğŸ“¦ mq-producer
â”‚  â”œâ”€ ğŸ“‚ src
â”‚  â”‚  â”œâ”€ ğŸ“‚ main
â”‚  â”‚  â”‚  â”œâ”€ ğŸ“‚ java
â”‚  â”‚  â”‚  â”‚  â””â”€ ğŸ“¦ com.juzicoding
â”‚  â”‚  â”‚  â”‚     â”œâ”€ ğŸ“¦ api
â”‚  â”‚  â”‚  â”‚     â”‚  â””â”€ â˜• RabbitTestApi.java
â”‚  â”‚  â”‚  â”‚     â”œâ”€ ğŸ“¦ config
â”‚  â”‚  â”‚  â”‚     â”‚  â”œâ”€ â˜• DirectConfig.java
â”‚  â”‚  â”‚  â”‚     â”‚  â”œâ”€ â˜• FanoutConfig.java
â”‚  â”‚  â”‚  â”‚     â”‚  â”œâ”€ â˜• TopicConfig.java
â”‚  â”‚  â”‚  â”‚     â”‚  â””â”€ â˜• WorkQueueConfig.java
â”‚  â”‚  â”‚  â”‚     â”œâ”€ ğŸ“¦ constant
â”‚  â”‚  â”‚  â”‚     â”‚  â””â”€ â˜• RabbitConstant.java
â”‚  â”‚  â”‚  â”‚     â””â”€ â˜• MqProducerApplication.java
â”‚  â”‚  â”‚  â””â”€ ğŸ“‚ resources
â”‚  â”‚  â”‚     â””â”€ âš™ï¸ application.yml
â”‚  â””â”€ ğŸ“„ pom.xml
â””â”€ ğŸ“„ pom.xml
```



### pom.xml é…ç½®

`rabbitmq-springboot -> pom.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.9</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>

    <groupId>com.juzicoding</groupId>
    <artifactId>rabbitmq-springboot</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>pom</packaging>
    <modules>
        <module>mq-producer</module>
        <module>mq-consumer</module>
    </modules>

    <properties>
        <maven.compiler.source>21</maven.compiler.source>
        <maven.compiler.target>21</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <!-- web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- ç®€åŒ–ä»£ç å¼€å‘ -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- RabbitMQ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-amqp</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>3.5.9</version>
            </plugin>
        </plugins>
    </build>

</project>
```



`mq-producer -> pom.xml`

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.juzicoding</groupId>
        <artifactId>rabbitmq-springboot</artifactId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>mq-producer</artifactId>

</project>
```



`mq-consumer -> pom.xml`

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.juzicoding</groupId>
        <artifactId>rabbitmq-springboot</artifactId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>mq-consumer</artifactId>

</project>
```



### aplication.yml é…ç½®

ä¸¤ä¸ªæœåŠ¡çš„ application.yml ä¸»è¦é…ç½®ã€‚

```yaml
spring:
  rabbitmq:
    host: 127.0.0.1
    port: 5672
    username: juzi
    password: juzi123456
    virtual-host: /juzi
```



### RabbitConstant å¸¸é‡

```java
public class RabbitConstant {

    public static final String WORK_QUEUE_NAME = "workQueue";

    public static final String FANOUT_QUEUE1_NAME = "fanoutQueue1";
    public static final String FANOUT_QUEUE2_NAME = "fanoutQueue2";
    public static final String FANOUT_EXCHANGE_NAME = "fanoutExchange";

    public static final String DIRECT_QUEUE_NAME = "directQueue";
    public static final String DIRECT_EXCHANGE_NAME = "directExchange";
    public static final String DIRECT_ROUTE_KEY = "directRouteKey";

    public static final String TOPIC_QUEUE_NAME = "topicQueue";
    public static final String TOPIC_EXCHANGE_NAME = "topicExchange";
    public static final String TOPIC_ROUTE_KEY = "juzi.*";

}
```



### æ¶ˆæ¯å‘é€æµ‹è¯• Api

```java
import com.juzicoding.constant.RabbitConstant;
import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@Slf4j
@RestController
@AllArgsConstructor
@RequestMapping("/rabbitTest")
public class RabbitTestApi {

    private final RabbitTemplate rabbitTemplate;

    @PostMapping("/workQueueSendMsg")
    private void workQueueSendMsg() {
        String msg = """
                {"templateId": "workQueue", "msg": "workQueueSendMsg"}
                """;
        rabbitTemplate.convertAndSend(RabbitConstant.WORK_QUEUE_NAME, msg);
        log.info("å‘é€æ¶ˆæ¯: {}", msg);
    }

    @PostMapping("/fanoutSendMsg")
    private void fanoutSendMsg() {
        String msg = """
                {"templateId": "fanout", "msg": "fanoutSendMsg"}
                """;
        rabbitTemplate.convertAndSend(RabbitConstant.FANOUT_EXCHANGE_NAME, "", msg);
        log.info("å‘é€æ¶ˆæ¯: {}", msg);
    }

    @PostMapping("/directSendMsg")
    private void directSendMsg() {
        String msg = """
                {"templateId": "direct", "code": "directSendMsg"}
                """;
        rabbitTemplate.convertAndSend(RabbitConstant.DIRECT_EXCHANGE_NAME, RabbitConstant.DIRECT_ROUTE_KEY, msg);
        log.info("å‘é€æ¶ˆæ¯: {}", msg);
    }

    @PostMapping("/topicSendMsg")
    private void topicSendMsg() {
        String msg = """
                {"templateId": "topic", "code": "topicSendMsg"}
                """;
        rabbitTemplate.convertAndSend(RabbitConstant.TOPIC_EXCHANGE_NAME, "juzi.coding.info", msg);
        log.info("å‘é€æ¶ˆæ¯: {}", msg);
    }

}
```

### Work Queue æ¨¡å‹

#### æ¶ˆæ¯å‘é€

```java
import com.juzicoding.constant.RabbitConstant;
import org.springframework.amqp.core.Queue;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class WorkQueueConfig {

    @Bean
    public Queue workQueue() {
        return new Queue(RabbitConstant.WORK_QUEUE_NAME, true);
    }

}
```



#### æ¶ˆæ¯æ¶ˆè´¹

```java
import com.juzicoding.constant.RabbitConstant;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class WorkQueueConsumer {

    @RabbitListener(queues = RabbitConstant.WORK_QUEUE_NAME)
    public void workQueueConsumer(String textMessageStr) {
        log.info("{} æ”¶åˆ°æ¶ˆæ¯ï¼š{}", RabbitConstant.WORK_QUEUE_NAME, textMessageStr);
    }

}
```



### Fanout äº¤æ¢æœº

#### æ¶ˆæ¯å‘é€

```java
import com.juzicoding.constant.RabbitConstant;
import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.FanoutExchange;
import org.springframework.amqp.core.Queue;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class FanoutConfig {

    @Bean
    public Queue fanoutQueue1() {
        return new Queue(RabbitConstant.FANOUT_QUEUE1_NAME, true);
    }

    @Bean
    public Queue fanoutQueue2() {
        return new Queue(RabbitConstant.FANOUT_QUEUE2_NAME, true);
    }

    @Bean
    public FanoutExchange fanoutExchange() {
        return new FanoutExchange(RabbitConstant.FANOUT_EXCHANGE_NAME, true, false);
    }

    @Bean
    public Binding fanoutBinding1(FanoutExchange fanoutExchange, Queue fanoutQueue1) {
        return BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);
    }

    @Bean
    public Binding fanoutBinding2(FanoutExchange fanoutExchange, Queue fanoutQueue2) {
        return BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);
    }

}
```



#### æ¶ˆæ¯æ¶ˆè´¹

```java
import com.juzicoding.constant.RabbitConstant;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class FanoutConsumer {

    @RabbitListener(queues = RabbitConstant.FANOUT_QUEUE1_NAME)
    public void fanoutQueue1Consumer(String textMessageStr) {
        log.info("{} æ”¶åˆ°æ¶ˆæ¯ï¼š{}", RabbitConstant.FANOUT_QUEUE1_NAME, textMessageStr);
    }

    @RabbitListener(queues = RabbitConstant.FANOUT_QUEUE2_NAME)
    public void fanoutQueue2Consumer(String textMessageStr) {
        log.info("{} æ”¶åˆ°æ¶ˆæ¯ï¼š{}", RabbitConstant.FANOUT_QUEUE2_NAME, textMessageStr);
    }

}
```



### Direct äº¤æ¢æœº

#### æ¶ˆæ¯å‘é€

```java
import com.juzicoding.constant.RabbitConstant;
import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.DirectExchange;
import org.springframework.amqp.core.Queue;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class DirectConfig {

    @Bean
    public Queue directQueue() {
        return new Queue(RabbitConstant.DIRECT_QUEUE_NAME, true);
    }

    @Bean
    public DirectExchange directExchange() {
        return new DirectExchange(RabbitConstant.DIRECT_EXCHANGE_NAME, true, false);
    }

    @Bean
    public Binding directBinding(Queue directQueue, DirectExchange directExchange) {
        return BindingBuilder.bind(directQueue).to(directExchange).with(RabbitConstant.DIRECT_ROUTE_KEY);
    }

}
```



#### æ¶ˆæ¯æ¶ˆè´¹

```java
import com.juzicoding.constant.RabbitConstant;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class DirectConsumer {

    @RabbitListener(queues = RabbitConstant.DIRECT_QUEUE_NAME)
    public void handlerDirectQueueMsg(String textMessageStr) {
        log.info("{} æ”¶åˆ°æ¶ˆæ¯ï¼š{}", RabbitConstant.DIRECT_QUEUE_NAME, textMessageStr);
    }

}
```



### Topic äº¤æ¢æœº

#### æ¶ˆæ¯å‘é€

```java
import com.juzicoding.constant.RabbitConstant;
import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.core.TopicExchange;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class TopicConfig {

    @Bean
    public Queue topicQueue() {
        return new Queue(RabbitConstant.TOPIC_QUEUE_NAME, true);
    }

    @Bean
    public TopicExchange topicExchange() {
        return new TopicExchange(RabbitConstant.TOPIC_EXCHANGE_NAME, true, false);
    }

    @Bean
    public Binding topicBinding(Queue topicQueue, TopicExchange topicExchange) {
        return BindingBuilder.bind(topicQueue).to(topicExchange).with(RabbitConstant.TOPIC_ROUTE_KEY);
    }

}
```



#### æ¶ˆæ¯æ¶ˆè´¹

```java
import com.juzicoding.constant.RabbitConstant;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class TopicConsumer {

    @RabbitListener(queues = RabbitConstant.TOPIC_QUEUE_NAME)
    public void topicConsumer(String textMessageStr) {
        log.info("{} æ”¶åˆ°æ¶ˆæ¯ï¼š{}", RabbitConstant.TOPIC_QUEUE_NAME, textMessageStr);
    }

}
```

